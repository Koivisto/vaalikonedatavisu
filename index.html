<!DOCTYPE html>
<head>
<title>Visualisointi (vaiheessa)</title>
<meta property="og:title" content="Data-analyysi ja visualisointi #vaalit2015" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Avoimen vaalidatan analysointia ja visualisointia. Lähteinä käytetty vaalikoneita, puolueohjelmia, toisten analyysejä ja vaalirahoitusta." />
<meta property="og:image" content="http://users.aalto.fi/~leinona1/sahlays/some/testImage.jpg" />
<!--
<meta property="article:author" content="" />
<meta property="article:tag" content="" />
<meta property="og:url" content="" />
<meta name="author" content="" />
<link rel="shortcut icon" href="" />
-->
<meta charset="utf-8"/>
<style type="text/css">
@-ms-viewport{
	width: device-width;
}
body{
	margin: 0px 0px 0px 0px; /*top right bottom left*/
	max-width: 1800px ;
	margin-left: auto;
	margin-right: auto;
	position: relative;
}
article{
	background: #83a0a5;
}
#explanations{
	color:#000;
	background-color: #FFF;
}
.infoBox{
	color:#000;
	background-color: #FFF;
	transform: translate(-50%, -100%);
	-webkit-transform: translate(-50%, -100%);
	-ms-transform: translate(-50%, -100%);
	box-shadow: 0px 0px 10px #000;
}

/*svg elements styles, ATTENTION! the syntax is different from pure html elements (color=fill etc.)*/
svg{
	background-color: #DDD;
}
text{
	fill: #FFFFFF;
}
.axisExplanation{
	fill: #000;
	font-size: 40px;
	text-anchor: end;
}
.partyLabes{
	fill: #000;
	font-size: 20px;
	text-anchor: end;
}
circle {
	stroke: #000;
	stroke-width: 1;
	fill: #FFF;
	opacity: 0.5;
}
circle.ui{
	opacity: 1.0;
}

@media only screen and (max-width: 999px){

}
</style>
<!--jQuery initializing-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!--D3.js library initializing-->
<script src="http://d3js.org/d3.v3.min.js"></script>
<!--Other javascript for the page-->
<script type="text/javascript">
</script>
</head>

<body>
	<article>

<header>
	<h1>Data-analyysi ja visualisointi #vaalit2015</h1>
	<p>Avoimen vaalidatan analysointia ja visualisointia. Alla olevassa visualisoinnissa HS vaalikoneen vastaukset faktorianalyysillä. Ehdokkaasta saa lisätietoja viemällä hiiren päälle.</p>
</header>

<!--Form that contains controls-->
<form id="visualizationForm"></form>

<!--Div that contains all explanations-->
<div id="explanations" style="position: absolute;"></div>

<!--Actual visualization inside svg-element-->
<div id="visualizationDiv">
	<svg id="visualizationSvg"></svg>
</div>

<!--Visualization logic-->
<script type="text/javascript" charset="utf-8">
/*Author: Aarne Leinonen (Juha Törmänen's code at <http://peili.kirkas.info/vis/politicianmap15b/js/politicianmap.js> was an inspiration as well as a guide)*/

var width = $(document).width();
var height = getHeight();
var MAXHEIGHT = 1000;
var MAXWIDTH = 1800;

/*Decides proper height for the visualization, that is window height or 1000px*/
function getHeight(){
	if( $(window).height() > MAXHEIGHT ){return MAXHEIGHT;}
	else{return $(window).height();}
};

var form = d3.select("#visualizationForm");
var svg = d3.select("#visualizationSvg");
svg
	.attr("width", width)
	.attr("height", height)

var parties = ["Itsenäisyyspuolue","Keskusta","Kokoomus","Kristillisdemokraatit","Muutos 2011","Perussuomalaiset","Piraattipuolue","RKP","SDP","SKP","STP","Vasemmistoliitto","Vihreät"];
var partyVisibility = {"Itsenäisyyspuolue" : true,"Keskusta" : true,"Kokoomus" : true,"Kristillisdemokraatit" : true,"Muutos 2011" : true,"Perussuomalaiset" : true,"Piraattipuolue" : true,"RKP" : true,"SDP" : true,"SKP" : true,"STP" : true,"Vasemmistoliitto" : true,"Vihreät" : true};
var axisValues = ["Impivaaralaisuus", "Talousoikeistolaisuus", "Arvoliberaalius", "Vihreys"];
var segments = ["Oikeisto","Kansalliskonservatiivit","Viherliberaalit","Vihervasemmisto","Demarit"];
//maps parties and segments to colors
function getColor(str){
	switch(str){
		//segments
		case "Oikeisto": return "blue";
		case "Kansalliskonservatiivit": return "grey";
		case "Viherliberaalit": return "#00BB00";
		case "Vihervasemmisto": return "#55110F";
		case "Demarit": return "#930C08";
		//parties
		case "Kokoomus": return "blue";
		case "RKP": return "yellow";
		case "Perussuomalaiset": return "grey";
		case "Keskusta": return "green";
		case "Vihreät": return "#00BB00";
		case "Vasemmistoliitto": return "#FF0700";
		case "SKP": return "#55110F";
		case "Kristillisdemokraatit": return "#9333C0";
		case "Itsenäisyyspuolue": return "#5596CC";
		case "Piraattipuolue": return "#000000";
		case "Muutos 2011": return "#AAFFFF";
		case "SDP": return "#930C08";
		case "STP": return "#FF4444";
		default: return "#FFFFFF";
	}
}

//Data begins
d3.csv("data.csv", function(d){

	/*Initializes UI elements inside the form*/

	//name and candidate number filtering
	var searchInput = form.append('input')
		.attr('placeholder', "Etsi nimellä/numerolla")
		.attr('type', 'text');
	searchInput.on('input', function() {
			redraw();
	});

	//Candidate color toggle on party/segment
	var showPartyColors = true;
	var partyRadioBtn = form.append("input")
		.attr("type", "radio")
		.attr("name", "color")
		.attr("value", "party")
		.attr("id", "party")
		.property("checked", true)
		.on("click", function() {showPartyColors = true; redraw();});
	form.append("label").html("Värit puolueittain");
	var segmentRadioBtn = form.append("input")
		.attr("type", "radio")
		.attr("name", "color")
		.attr("value", "segment")
		.attr("id", "segment")
		.property("checked", false)
		.on("click", function() {showPartyColors = false; redraw();});
	form.append("label").html("Värit segmenteittäin");

	//District option menu
	var districtSelector = form.append("select");
	districtSelector.append("option")
		.attr("value", "all")
		.text("Valitse alue");
	// Data parsing for voting districts that are present
	var areadict = {}, areas = [];
	d.forEach(function(d) {
		areadict[d.district] = true;
	});
	for (key in areadict) {
		areas.push(key);
	}
	areas.push("-Koko maa-");
	areas.sort();
	//holds the selected district outside the redraw()
	var currentDistrict = null;

	//X and Y axis selection option menus
	var axisXSelector = form.append("select");
	axisXSelector.append("option")
		.attr("value", "all")
		.text("Valitse X-akseli");
	var axisYSelector = form.append("select");
	axisYSelector.append("option")
		.attr("value", "all")
		.text("Valitse Y-akseli");

/***********************************************************************
	Visualization resizing starts
***********************************************************************/
	function redraw() {
		//Removing old elements
		svg.selectAll("circle").remove();
		svg.selectAll("text").remove();
		svg.selectAll("line").remove();
		removeInfoDivs();

		width = $("#visualizationDiv").width();
		var height = getHeight();
		svg
			.attr("width", width)
			.attr("height", height)

		//Axis selection
		var xAxisValue = axisValues[0], yAxisValue = axisValues[2];
		function changeAxisX(){
			if (axisXSelector.property('selectedIndex') > 0) {
				xAxisValue = axisValues[axisXSelector.property('selectedIndex')-1];
			}
		}
		changeAxisX();//redraw is called when axis are changed
		function changeAxisY(){
			if (axisYSelector.property('selectedIndex') > 0) {
				yAxisValue = axisValues[axisYSelector.property('selectedIndex')-1];
			}
		}
		changeAxisY();//redraw is called when axis are changed

		//Lazy enum for axis labels
		function getXValue(d){
			return getValueFromStr(d, xAxisValue);
		}
		function getYValue(d){
			return getValueFromStr(d, yAxisValue);
		}
		function getValueFromStr(d, str){
			switch(str){
				case "Impivaaralaisuus": return d.imp;
				case "Talousoikeistolaisuus": return d.oik;
				case "Arvoliberaalius": return d.lib;
				case "Vihreys": return d.vih;
				default: return 0;}
		}

		//Draw axis
		//horisontal xAxis
		var line = svg.append("line")
			.attr("x1", 0)
			.attr("y1", height/2)
			.attr("x2", width)
			.attr("y2", height/2)
			.attr("stroke-width", 2)
			.attr("stroke", "black");
		var text = svg.append("text")
			.attr("x", width)
			.attr("y", height/2)
			.attr("class", "axisExplanation")
			.text(xAxisValue);
		//vertical yAxis
		var line = svg.append("line")
			.attr("x1", width/2)
			.attr("y1", 0)
			.attr("x2", width/2)
			.attr("y2", height)
			.attr("stroke-width", 2)
			.attr("stroke", "black");
		var text = svg.append("text")
			.attr("x", width/2)
			.attr("y", 30)
			.attr("class", "axisExplanation")
			.text(yAxisValue);

		//scales the data to screen size, these variables are used as functions later on.
		var linearWidthScale = d3.scale.linear()
			.domain([-3,3])//these might vary
			.range([0,width]);
		var linearHeigthScale = d3.scale.linear()
			.domain([3,-3])
			.range([0,height]);
		var linearElementScale = d3.scale.linear()
			.domain([0, MAXHEIGHT])
			.range([2,10]);

		/*Party selection UI elements and logic*/
		var partySelectionGroup = svg.append("g")
		var tick = 0;
		function getNextTick(){tick = tick +1;return tick;}
		//circles presenting the parties
		var partiesSelection = partySelectionGroup.selectAll("circle")
			.data(parties)
			.enter()
				.append("circle")
				.attr("cx", function(parties){return width-20;})
				.attr("cy", function(parties){return +(getNextTick()*20);})
				.attr("r", function(parties){return linearElementScale(height);})
				.attr("class", "ui")
				.style("fill", function(parties){return getColor(parties)})
				.style("opacity", function(parties){return getOpacity(partyVisibility[parties]);})
				.on("click", function(parties){
					toggleSelection(parties, d3.select(this));
					filterCandidates();});
		tick = 0;
		//text labels for circles
		var partyLabes = partySelectionGroup.selectAll("text")
			.data(parties)
			.enter()
				.append("text")
				.attr("x", function(parties){return width-35;})
				.attr("y", function(parties){return +(getNextTick()*20 +5);})
				.attr("class", "partyLabes")
				.text(function(d){return d;});

		function toggleSelection(party, element){
			partyVisibility[party] = !partyVisibility[party];
			element.style("opacity", function(){return getOpacity(partyVisibility[party]);});
		}

		function getOpacity(boolean){
			if(boolean) return 1.0;
			return 0.3;
		}

		var isClicked = false;
		var previousCandidate = null;
		var candidate= null;

		/*Main logic is here, when data is used to create DOM elements, and events are decided*/
		/*Connects the data to svg elements, determines the interaction logic*/
		var candidateGroup = svg.append("g")
		var candidates = candidateGroup.selectAll("circle")
			.data(d)
			.enter()
				.append("circle")
				.attr("cx", function(d){return linearWidthScale(getXValue(d));})
				.attr("cy", function(d){return linearHeigthScale(getYValue(d));})
				.attr("r", function(d){return linearElementScale(height);});
		
		/*Assign actions on candidate elements
		It is possible to click candidate, so the info will keep showing*/
		candidates
				.on('click', function(d){
					isClicked = !isClicked;
					defineCandidate(d, d3.select(this));
					displayInfo(candidate);
					previousCandidate = candidate;
					})
				.on('mouseenter', function(d){
					defineCandidate(d, d3.select(this));
					if(previousCandidate != null && isClicked){
						dontDisplayInfo(previousCandidate);
						isClicked = !isClicked;}//prepares for new a click
					displayInfo(candidate);
					})
				.on('mouseleave', function(d){
					defineCandidate(d, d3.select(this));
					if(!isClicked){dontDisplayInfo(candidate);};
					})
				.on('touchstart', function(d){
					defineCandidate(d, d3.select(this));
					displayInfo(candidate);
					})
				.on('touchend', function(d){
					defineCandidate(d, d3.select(this));
					if(!isClicked){dontDisplayInfo(candidate)};
		});

		/*Style for candidate elements*/
		candidates.style("fill", function(d){
			if(showPartyColors)	return getColor(d.party);
			return getColor(d.segment)
		});

		/*Sets display to none for filtered candidate elements*/
		function filterCandidates(){
			//updates district filter
			if (districtSelector.property('selectedIndex') > 0) {
				currentDistrict = areas[districtSelector.property('selectedIndex')-1];
			}
			//updates name and candidate number filter
			var searchValue = searchInput.property('value').toLowerCase();
			var searchArray = searchValue.split(' ');

			//Let the filtering begin!
			candidates
				.attr('display', function(d) { 
					//district filter
					if (currentDistrict === "-Koko maa-") return "inline";
					else if (currentDistrict && d.district !== currentDistrict) return 'none';

					if(!partyVisibility[d.party]) return "none";

					//if something in the search box then also filter with that
					if (searchValue) {
						for (var i = 0; i < searchArray.length; i++) {
							//name as default
							if (d.name.toLowerCase().indexOf(searchArray[i].trim()) < 0){
								//candidate voting number as secondary quess for input
								if (d.id.toLowerCase().indexOf(searchArray[i].trim()) < 0){
									return "none";	}
							} 
						}
					}
				})
		}
		filterCandidates();

		/*Creates candidate data object containing element, name, party, segment, 
		id (candidate number), district, age, education, url, xCoordinate, yCoordinate*/
		function defineCandidate(d, givenElement){
			candidate = {element: givenElement, 
							name: d.name, 
							party: d.party, 
							segment: d.segment,
							id: d.id,
							district: d.district,
							age: d.age,
							education: d.education,
							url: d.www,
							xCoordinate: +getXValue(d), 
							yCoordinate: +getYValue(d)};
			return candidate;
		}

		/*highlights svg element, creates infoBox div with candidate information*/
		function displayInfo(candidate){
			candidate.element
				.transition()
				.duration(300)
				.attr("r", function(d){return linearElementScale(height)*2;})

			//html text for infoBox
			var infoString = candidate.name+", nro: "+ candidate.id+"<br>"+
				candidate.party+"<br>"+
				"segmentissä: \""+candidate.segment+"\"<br>"+
				candidate.district+"<br>"+
				candidate.education+"<br>"+
				candidate.age+" vuotias<br>"+
				"**debug: x:"+candidate.xCoordinate+" y:"+candidate.yCoordinate+"**"+
				"<br><a href=\""+candidate.url+"\">"+candidate.url+"</a>";

			//infoBox above candidates
			var infoDiv = document.createElement('div');
			document.getElementById('explanations').appendChild(infoDiv);
			infoDiv.className = "infoBox";
			infoDiv.id = candidate.name;
			infoDiv.innerHTML = infoString;
			infoDiv.style.position = "absolute";
			infoDiv.style.left = parseInt(candidate.element.attr("cx") + svg.offsetLeft) + "px";
			infoDiv.style.top = parseInt(candidate.element.attr("cy") + svg.offsetTop) +-10+"px";
			infoDiv.style.width = "200px";
			infoDiv.style.opacity = "0.95";

			//infobox closing button
			var closeButton = document.createElement("BUTTON");
			closeButton.appendChild(document.createTextNode("sulje"));
			closeButton.addEventListener("click",function(d){dontDisplayInfo(candidate);});
			infoDiv.appendChild(closeButton);
		}

		/*restores the svg element size, deletes the infoBox div*/
		function dontDisplayInfo(candidate){
			candidate.element
				.transition()
				.duration(300)
				.attr("r", function(d){return linearElementScale(height);})

			var infoDiv= document.getElementById(candidate.name);
			infoDiv.parentNode.removeChild(infoDiv);
		}

		/*removes all info boxes present*/
		function removeInfoDivs(){
			var explanationsDiv = document.getElementById("explanations");
			while (explanationsDiv.hasChildNodes()) {
			    explanationsDiv.removeChild(explanationsDiv.lastChild);
			}
		}

		/*UI control for district (needs to be inside resizing)*/
		districtSelector.selectAll("option.local")
			.data(areas)
			.enter().append("option")
				.attr("class", "local")
				.attr("value", function(d) { return d; })
				.text(function(d) { return d; });
		districtSelector.on("change", function(){
			filterCandidates();
		});
	}
/***********************************************************************
	Visualization resizing ends
***********************************************************************/

	d3.select(window).on("resize", redraw); 
	redraw();

	/*UI control for axis*/
	axisXSelector.selectAll("option.local")
		.data(axisValues)
		.enter().append("option")
			.attr("class", "local")
			.attr("value", function(d) { return d; })
			.text(function(d) { return d; });
	axisYSelector.selectAll("option.local")
		.data(axisValues)
		.enter().append("option")
			.attr("class", "local")
			.attr("value", function(d) { return d; })
			.text(function(d) { return d; });
	axisXSelector.on("change", function(){redraw();});
	axisYSelector.on("change", function(){redraw();});

});//Data ends

</script>

<p>Tekijöitä (tässä vaiheessa): Aarne Leinonen (koodi), Markku Niemivirta (faktorianalyysi, data)</p>

<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://users.aalto.fi/~leinona1/sahlays/" data-text="KESKEN - ÄLÄ JAA PLS! Vaalidatan faktorianalyysiä @AarneLeinonen @mniemivirta" data-hashtags="vaalit2015">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

	</article>
</body>
</html>